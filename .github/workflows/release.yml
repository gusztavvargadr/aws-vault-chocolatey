name: Release

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  release:
    name: Release
    runs-on: windows-2022
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: extract-version
        shell: pwsh
        run: |
          $tag = '${{ github.ref }}'
          $version = $tag -replace '^refs/tags/v', ''
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Releasing version: $version"

      - name: Find previous version
        id: find-previous
        shell: pwsh
        run: |
          # Get all tags in reverse chronological order
          $currentTag = 'v${{ steps.extract-version.outputs.version }}'
          $allTags = git tag -l --sort=-version:refname | Select-Object -Skip 1
          
          if ($allTags) {
            $previousTag = $allTags | Select-Object -First 1
            $previousVersion = $previousTag -replace '^v', ''
          } else {
            $previousVersion = "initial"
          }
          
          "version=$previousVersion" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Previous version: $previousVersion"

      - name: Init .NET
        run: dotnet tool restore

      - name: Generate release notes
        run: dotnet cake --target GenerateReleaseNotes --release-version ${{ steps.extract-version.outputs.version }} --release-previous-version ${{ steps.find-previous.outputs.version }}

      - name: Package Cake
        run: dotnet cake --target package

      - name: Publish Cake
        env:
          CHOCOLATEY_SERVER: ${{ vars.CHOCOLATEY_SERVER }}
          CHOCOLATEY_API_KEY: ${{ secrets.CHOCOLATEY_API_KEY }}
        run: dotnet cake --target publish --exclusive

      - name: Upload Chocolatey Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: chocolatey-${{ steps.extract-version.outputs.version }}
          path: artifacts/chocolatey/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ steps.extract-version.outputs.version }}
          name: v${{ steps.extract-version.outputs.version }}
          body_path: artifacts/release-notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Clean Cake
        run: dotnet cake --target clean
        if: always()
