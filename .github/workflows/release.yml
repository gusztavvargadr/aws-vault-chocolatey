name: Release

on:
  push:
    tags:
      - 'v*'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: write
  actions: read

jobs:
  release:
    name: Release
    runs-on: windows-2022
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Extract version from tag
        id: extract-version
        shell: pwsh
        run: |
          $tag = '${{ github.ref }}'
          $version = $tag -replace '^refs/tags/v', ''
          "version=$version" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          Write-Host "Releasing version: $version"

      - name: Init .NET
        run: dotnet tool restore

      - name: Restore Docker image
        run: dotnet cake --target Restore

      - name: Find CD workflow run
        id: find-cd
        uses: actions/github-script@v8
        with:
          script: |
            const workflowFile = 'cd.yml';
            const response = await github.rest.actions.listWorkflowRuns({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: workflowFile,
              head_sha: context.sha,
              status: 'success',
              per_page: 1
            });

            if (!response.data.workflow_runs.length) {
              throw new Error(`No successful ${workflowFile} run found for ${context.sha}.`);
            }

            core.setOutput('run_id', response.data.workflow_runs[0].id.toString());

      - name: Download Chocolatey artifacts
        uses: actions/download-artifact@v4
        with:
          name: chocolatey
          run-id: ${{ steps.find-cd.outputs.run_id }}
          github-token: ${{ github.token }}
          repository: ${{ github.repository }}
          path: artifacts/chocolatey

      - name: Validate package artifact
        shell: pwsh
        run: |
          $version = '${{ steps.extract-version.outputs.version }}'
          $packagePath = "artifacts/chocolatey/packages/aws-vault.$version.nupkg"
          if (-not (Test-Path $packagePath)) {
            throw "Expected package not found: $packagePath"
          }

      - name: Publish Chocolatey package
        env:
          CHOCOLATEY_SERVER: ${{ vars.CHOCOLATEY_SERVER }}
          CHOCOLATEY_API_KEY: ${{ secrets.CHOCOLATEY_API_KEY }}
        run: docker compose run --rm --entrypoint "powershell -File ./build/chocolatey/package.push.ps1" chocolatey ${{ steps.extract-version.outputs.version }}

      - name: Check for existing draft release
        id: check-release
        uses: actions/github-script@v8
        with:
          script: |
            try {
              const response = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: 'v${{ steps.extract-version.outputs.version }}'
              });
              
              if (response.data.draft) {
                core.setOutput('exists', 'true');
                core.setOutput('release_id', response.data.id.toString());
                core.info('Found existing draft release');
              } else {
                core.setOutput('exists', 'published');
                core.info('Release already published, skipping');
              }
            } catch (error) {
              if (error.status === 404) {
                core.setOutput('exists', 'false');
                core.info('No existing release found');
              } else {
                throw error;
              }
            }

      - name: Publish existing draft release
        if: steps.check-release.outputs.exists == 'true'
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release edit v${{ steps.extract-version.outputs.version }} --draft=false
          Write-Host "Published draft release v${{ steps.extract-version.outputs.version }}"

      - name: Skip if already published
        if: steps.check-release.outputs.exists == 'published'
        run: |
          echo "Release v${{ steps.extract-version.outputs.version }} is already published, skipping"

      - name: Create GitHub Release (fallback)
        if: steps.check-release.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.extract-version.outputs.version }}
          name: v${{ steps.extract-version.outputs.version }}
          body: |
            Release for aws-vault v${{ steps.extract-version.outputs.version }}
            
            See [upstream release](https://github.com/ByteNess/aws-vault/releases/tag/v${{ steps.extract-version.outputs.version }}) for details.
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: Clean Cake
        run: dotnet cake --target clean
        if: always()
